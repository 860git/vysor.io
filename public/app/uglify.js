function nextTick(e){setTimeout(e,0)}function make4Len16(e){var t=e.toString(16);while(t.length<4){t="0"+t}return t}var pendingFuncs;window.addEventListener("message",function(){if(pendingFuncs){$.each(pendingFuncs,function(e,t){t()});pendingFuncs=null}},false);function unsafeCallback(e){return e}function encode_utf8(e){return unescape(encodeURIComponent(e))}function decode_utf8(e){return decodeURIComponent(escape(e))}function ab2str(e){if(e.constructor.name=="ArrayBuffer"){e=new Uint8Array(e)}return decode_utf8(String.fromCharCode.apply(null,e))}function str2ab(e,t,n){e=encode_utf8(e);var o=e.length;if(n)o++;if(!t){t=new ArrayBuffer(o)}var i=new Uint8Array(t);if(n)i[e.length]=0;for(var r=0,s=e.length;r<s;r++){i[r]=e.charCodeAt(r)}return t}var slashN="\n".charCodeAt(0);function writeLine(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);writeString(e,t+"\n",n)}function readLine(e,t){var n=[];function o(){e.read(function(i){for(var r=0;r<i.byteLength;r++){if(i[r]==slashN){var s=i.subarray(0,r);n.push(s);var c="";for(var a in n){a=n[a];c+=ab2str(a)}var d=i.subarray(r+1);e.unshift(d);t(c);return}}n.push(i);o()})}o()}function readString(e,t){var n="";e.onClose=function(){t(n)};function o(t){n+=ab2str(t);e.read(o)}e.read(o)}function writeString(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);e.write(str2ab(t),n)}function appendBuffer(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);n.set(e,0);n.set(t,e.byteLength);return n}var timeThing=(new Date).getTime();function timeTrace(e){var t=(new Date).getTime();console.log(e+": "+(t-timeThing));timeThing=t}function bufferToHex(e){var t=new Uint8Array(e);var n="";for(var o in t){o=t[o];if(o<16)n+="0"+o.toString(16);else n+=o.toString(16)}return n}function hexToBuffer(e){var t=new ArrayBuffer(e.length/2);var n=new Uint8Array(t);for(var o=0;o<e.length/2;o++){var i=e.substr(o*2,2);n[o]=parseInt(i,16)}return t}function base64ToArrayBuffer(e){var t=window.atob(e);var n=t.length;var o=new Uint8Array(n);for(var i=0;i<n;i++){var r=t.charCodeAt(i);o[i]=r}return o.buffer}function arrayBufferToBase64(e){var t="";var n=new Uint8Array(e);var o=n.byteLength;for(var i=0;i<o;i++){t+=String.fromCharCode(n[i])}return window.btoa(t)}var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64pad="=";function hex2b64(e){var t;var n;var o="";for(t=0;t+3<=e.length;t+=3){n=parseInt(e.substring(t,t+3),16);o+=b64map.charAt(n>>6)+b64map.charAt(n&63)}if(t+1==e.length){n=parseInt(e.substring(t,t+1),16);o+=b64map.charAt(n<<2)}else if(t+2==e.length){n=parseInt(e.substring(t,t+2),16);o+=b64map.charAt(n>>2)+b64map.charAt((n&3)<<4)}while((o.length&3)>0){o+=b64pad}return o}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,"startsWith",{enumerable:false,configurable:false,writable:false,value:function(e,t){t=t||0;return this.lastIndexOf(e,t)===t}})}function getQueryVariable(e,t){if(!t)t=window.location;var n=t.search.substring(1);var o=n.split("&");for(var i=0;i<o.length;i++){var r=o[i].split("=");if(decodeURIComponent(r[0])==e){return decodeURIComponent(r[1])}}}Object.fromArray=function(e){var t={};for(var n in e){var o=e[n];t[o]=o}return t};$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&e.dataType=="binary"||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))){return{send:function(t,n){var o=new XMLHttpRequest,i=e.url,r=e.type,s=e.async||true,c=e.responseType||"blob",a=e.data||null,d=e.username||null,u=e.password||null;o.addEventListener("load",function(){var t={};t[e.dataType]=o.response;n(o.status,o.statusText,t,o.getAllResponseHeaders())});o.open(r,i,s,d,u);for(var l in t){o.setRequestHeader(l,t[l])}o.responseType=c;o.send(a)},abort:function(){n.abort()}}}});function throttleTimeout(e,t,n,o){if(e){clearTimeout(e.timeout)}else{e={items:[]}}e.timeout=setTimeout(function(){o(e.items);e.items=[]},n);e.items.push(t);return e}function copyTextToClipboard(e){var t=document.createElement("textarea");t.style.position="fixed";t.style.top=0;t.style.left=0;t.style.width="2em";t.style.height="2em";t.style.padding=0;t.style.border="none";t.style.outline="none";t.style.boxShadow="none";t.style.background="transparent";t.value=e;document.body.appendChild(t);t.select();try{var n=document.execCommand("copy")}catch(o){console.log("Oops, unable to copy")}document.body.removeChild(t)}function showNotification(e,t){console.log("notification:",e);if(!window.chrome||!window.chrome.notifications)return;var n=chrome.runtime.getManifest();var o=n.name;t=t||n.icons[128];chrome.notifications.create({type:"basic",iconUrl:t,title:o,message:e})}var blobFromUrl=function(){var e={};return function(t,n){if(e[t]){n(e[t]);return}var o=new XMLHttpRequest;o.open("GET",t,true);o.responseType="blob";o.onload=function(o){n(e[t]=window.URL.createObjectURL(this.response))};o.send()}}();function Success(){}(function(){function*e(){}var t=e();t.constructor.prototype.async=function(){var e=this;var t=e.next();if(t.done)return;function n(){t=e.throw(new Error(arguments));i()}function o(){var n=arguments[0];t=e.next(n);i()}function i(i){var r;var s;if(t.done)return;if(!t.value){t=e.next(o);return}if(t.value.constructor==Promise){t.value.then(o).catch(n);return}if(t.value==Error){r=true;t=e.next(n)}else if(t.value==Success){s=true;t=e.next(o)}else{throw new Error("Unexpected yield value for callback. Only Error and Success allowed.")}if(!t.value)throw new Error("Double yield callbacks must explicitly define both Error and Success");if(t.value==Error&&r)throw new Error("Error callback already defined");else if(t.value==Success&&s)throw new Error("Success callback already defined");else if(t.value!=Error&&t.value!=Success)throw new Error("Unexpected yield value for callback. Only Error and Success allowed.");if(r)t=e.next(o);else t=e.next(n)}i()}})();function spewSocket(e){e.read(function(t){console.log(ab2str(t));spewSocket(e)})}if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.dataReceived(new Uint8Array(e.data))});chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.destroy();t.dataReceived(null)});chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,false);var t=Server.listeners[e.socketId];if(t==null)return;t(new Socket({socketId:e.clientSocketId}))})}(function(){function e(t,n){if(t.socketId){this.socketId=t.socketId;e.readers[this.socketId]=this}else{chrome.sockets.tcp.create(function(o){this.socketId=o.socketId;chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){chrome.runtime.lastError;if(!t){e.readers[o.socketId]=this;n(this)}else{this.destroy();n(null)}}.bind(this))}.bind(this))}}e.readers={};e.connect=function(t,n){return new e(t,n)};e.pump=function(e,t,n){var o=function(){e.read(i)}.bind(e);var i=function(e){var n=e.buffer;if(e.byteOffset||e.length!=n.byteLength){n=n.slice(e.byteOffset,e.byteOffset+e.length)}t.write(n,o)}.bind(t);e.read(i);e.onClose=n};e.stream=function(t,n,o){e.pump(t,n,function(){n.destroy();if(o){var e=o;o=null;e()}});e.pump(n,t,function(){t.destroy();if(o){var e=o;o=null;e()}})};e.eat=function(e){function t(){e.read(t)}t()};e.prototype.read=function(){if(this.pendingCallback){throw new Error("double callback")}if(this.closed&&!this.pending){var e=this.onClose;if(e){delete this.onClose;e()}return}var t=0;if(arguments[t].constructor.name=="Number"){this.pendingLength=arguments[t++]}else{this.pendingLength=0}var e=arguments[t];if(!this.pending||this.paused){this.pendingCallback=e;return}if(!this.pendingLength){this.pendingLength=this.buffered()}else if(this.pendingLength>this.buffered()){this.pendingCallback=e;return}var n;var o=0;while(o<this.pendingLength){var i=this.pending.shift();this.bufferedLength-=i.length;if(!this.pending.length)delete this.pending;var r=i;var s=Math.min(r.byteLength,this.pendingLength-o);if(s!=r.byteLength){var c=r.subarray(0,s);var a=r.subarray(s);this.unshift(a);r=c}if(!n&&r.byteLength!=this.pendingLength)n=new Uint8Array(this.pendingLength);if(n){n.set(r,o)}else{n=r}o+=r.byteLength}e(n)};e.prototype.write=function(e,t){if(this.pendingWrite)console.error("write is already in progress!");if(t==null){console.error("write callback is null?");t=function(){}}this.pendingWrite=t;chrome.sockets.tcp.send(this.socketId,e,function(n){chrome.runtime.lastError;if(!n||n.resultCode){delete this.pendingWrite;return}if(n.bytesSent<e.byteLength){this.write(e.slice(n.bytesSent),t)}else{delete this.pendingWrite;t()}}.bind(this))};e.prototype.destroy=function(e,t){chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError})};e.prototype.unshift=function(e){if(e.byteLength==0)return;if(!this.pending)this.pending=[e];else this.pending.unshift(e);if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length};e.prototype.dataReceived=function(e){if(e&&e.length){var t=new Uint8Array(e);if(!this.pending)this.pending=[t];else this.pending.push(t)}if(e==null){this.closed=true}else{if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length}if(this.paused||!this.pending||!this.pending.length){var n=this.onClose;if(this.closed&&n){delete this.onClose;n()}return}var o=this.pendingLength;var n=this.pendingCallback;if(n){delete this.pendingCallback;this.read(o,n)}};e.prototype.buffered=function(){return this.bufferedLength};e.prototype.pause=function(){if(this.paused){return}this.paused=true;this.onPause()};e.prototype.resume=function(){if(!this.paused){return}this.paused=false;this.onResume()};e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,false,function(){})};e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,true,function(){})};function t(){}t.listeners={};t.prototype.__proto__=e.prototype;t.prototype.destroy=function(){chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError})};t.prototype.listen=function(e,n,o){var i;var r;if(e.constructor.name=="Number"){i=e;r="0.0.0.0"}else{r=e.address;i=e.port}chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId;t.listeners[this.socketId]=n;chrome.sockets.tcpServer.listen(e.socketId,r,i,function(e){chrome.runtime.lastError;if(e){this.destroy();if(o){o(e)}return}chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress;this.localPort=t.localPort;if(o){o(e)}}.bind(this))}.bind(this))}.bind(this))};window.Socket=e;window.Server=t})();function DummySocket(e){this.dataReceived(e);this.dataReceived(null)}DummySocket.prototype.write=function(e,t){throw new Error("write not supported on dummy socket")};DummySocket.prototype.destroy=function(){};DummySocket.prototype.buffered=Socket.prototype.buffered;DummySocket.prototype.unshift=Socket.prototype.unshift;DummySocket.prototype.dataReceived=Socket.prototype.dataReceived;DummySocket.prototype.read=Socket.prototype.read;DummySocket.prototype.pause=Socket.prototype.pause;DummySocket.prototype.resume=Socket.prototype.resume;DummySocket.prototype.buffered=Socket.prototype.buffered;DummySocket.prototype.onPause=function(){};DummySocket.prototype.onResume=function(){};function FetchSocket(e,t){this.promise=fetch(e).then(function(e){this.connected=true;this.response=e;this.reader=this.response.body.getReader();this.reader.closed.then(function(){if(this.onClose)this.dataReceived(null)}.bind(this));this.onResume();t(this)}.bind(this),function(e){t(null,e)})}FetchSocket.connect=function(e,t){new FetchSocket(e,t)};FetchSocket.prototype.write=function(e,t){throw new Error("write not supported on fetch socket")};FetchSocket.prototype.destroy=function(){if(this.promise&&this.promise.cancel)this.promise.cancel()};FetchSocket.prototype.unshift=Socket.prototype.unshift;FetchSocket.prototype.dataReceived=Socket.prototype.dataReceived;FetchSocket.prototype.read=Socket.prototype.read;FetchSocket.prototype.pause=Socket.prototype.pause;FetchSocket.prototype.resume=Socket.prototype.resume;FetchSocket.prototype.buffered=Socket.prototype.buffered;FetchSocket.prototype.onPause=function(){};FetchSocket.prototype.onResume=function(){this.reader.read().then(function(e){if(!e.value)return;this.dataReceived(e.value);if(this.paused){return}this.onResume()}.bind(this))};(function(){function e(e,t){this.conn=e;this.dc=t;this.gotEof=false;t.onmessage=function(e){var t=new Uint8Array(e.data);var n=t[t.byteLength-1]==1;this.dataReceived(t.subarray(0,t.byteLength-1));if(n){this.gotEof=true;this.destroy()}}.bind(this);t.onclose=t.onerror=this.destroy.bind(this);this.needsBufferShim=true||parseInt(/Chrome\/(\d\d)/.exec(navigator.userAgent)[1])<46}e.prototype.buffered=Socket.prototype.buffered;e.prototype.unshift=Socket.prototype.unshift;e.prototype.dataReceived=Socket.prototype.dataReceived;e.prototype.read=Socket.prototype.read;e.prototype.pause=Socket.prototype.pause;e.prototype.resume=Socket.prototype.resume;e.prototype.buffered=Socket.prototype.buffered;e.prototype.writeable=function(){var e=this.writeCallback;if(e){delete this.writeCallback;e()}};e.prototype.write=function(e,t){if(!this.dc||this.dc.readyState!="open"){this.destroy();return}this.writeCallback=t;var n=new Uint8Array(e.byteLength+1);n.set(new Uint8Array(e));this.dc.send(n.buffer);if(this.reentrantWrite)return;try{this.reentrantWrite=true;while(this.writeCallback&&(this.dc.bufferedAmount==0||this.needsBufferShim)){this.writeable()}}finally{this.reentrantWrite=false}};e.prototype.destroy=function(){this.dataReceived(null);if(this.dc==null)return;var e=this.dc;this.dc=null;e.onclose=null;e.onerror=null;if(e.readyState=="open"){try{e.send(new Uint8Array([1]));if(this.gotEof)this.conn.recycleChannel(e);else this.conn.waitForEof(e)}catch(t){}}};function t(e,t){this.pc=e;this.key=t;this.pc.oniceconnectionstatechange=function(){if(this.pc.iceConnectionState=="disconnected"||this.pc.iceConnectionState=="closed"){this.destroy();delete n.gcmRtcConnections[t]}}.bind(this)}t.prototype.waitForCommand=function(t){t.onmessage=function(n){if(n.data.byteLength==1)return;this.removeChannel(t);var o=ab2str(n.data);var i=new e(this,t);this.openSocket(o,i)}.bind(this)};t.prototype.compactChannels=function(){if(this.inboundChannels&&!this.inboundChannels.length)this.inboundChannels=null;if(this.outboundChannels&&!this.outboundChannels.length)this.outboundChannels=null};t.prototype.getAppropriateChannels=function(e,t){var n;if(e.inbound){if(!this.inboundChannels&&t)this.inboundChannels=[];n=this.inboundChannels}else{if(!this.outboundChannels&&t)this.outboundChannels=[];n=this.outboundChannels}return n};t.prototype.removeChannel=function(e){t;channels=this.getAppropriateChannels(e);if(!channels)return;var t=channels.indexOf(e);if(t==-1)return;channels.splice(t,1);this.compactChannels()};t.prototype.waitForEof=function(e){e.onmessage=function(t){var n=new Uint8Array(t.data);var o=n[n.byteLength-1]==1;if(o)this.recycleChannel(e)}.bind(this)};t.prototype.recycleChannel=function(e){var t=this.getAppropriateChannels(e,true);t.push(e);e.onclose=e.onerror=function(){this.removeChannel(e)}.bind(this);this.waitForCommand(e)};t.prototype.addCandidates=function(e){for(var t in e.candidates){this.pc.addIceCandidate(new RTCIceCandidate(e.candidates[t]))}};t.prototype.setupPinger=function(e){var t;function n(){e.send(str2ab("ping"));t=setTimeout(n,1e3)}e.onmessage=function(e){};e.onclose=e.onerror=function(){clearTimeout(t);this.destroy()}.bind(this);n()};t.prototype.listenSockets=function(){this.pc.ondatachannel=function(e){e.channel.inbound=true;this.waitForCommand(e.channel)}.bind(this)};t.prototype.prepareChannel=function(e){var t=this.pc.createDataChannel(e||"gcm",{reliable:true,ordered:true});t.binaryType="arraybuffer";return t};t.prototype.newSocket=function(t,n){if(this.pc.signalingState=="closed"){n();return}if(this.outboundChannels){var o=this.outboundChannels.shift();this.compactChannels();o.send(str2ab(t));var i=new e(this,o);n(i,this);return}var o=this.prepareChannel("gcm");o.onopen=function(){o.send(str2ab(t));var i=new e(this,o);n(i,this)}.bind(this)};t.prototype.destroy=function(){if(this.pc.signalingState!="closed"){this.pc.close()}var e=this.onClose;if(e){delete this.onClose;e()}};function n(e,t,n){this.senders=e;this.registrationId=t;this.rtcc=n}n.gcmRtcConnections={};n.onMessage=function(e){var t=JSON.parse(e.message);var o=e.type;var i=e.senderId;var r=e.src;var s=e.srcPort;var c=e.dstPort;if(o=="offer"){var a=n.gcmRtcListeners[c];if(!a)console.log("not listening on "+c);else a.listener.incoming(i,r,s,c,t,a.listenCallback);return}else if(o=="answer"){var d=n.getKey(r,s,c);var u=n.gcmRtcConnections[d];if(!u){console.log("pending connection not found");return}u.manager.incoming(i,r,s,c,t);return}console.log("unknown message "+o)};n.hasLoadedChannels=false;n.start=function(e,t,o){if(window.chrome&&window.chrome.gcm){var i=Object.keys(e);chrome.gcm.register(i,function(i){chrome.runtime.lastError;if(!i){o();return}var r=new n(e,i,t);o(r)})}else{function r(){$.ajax({type:"GET",url:"https://vysor-1026.appspot.com/listen",success:function(i){var r=new goog.appengine.Channel(i.token);var s={onopen:function(){var r=new n(e,"web:"+i.channel,t);o(r)},onmessage:function(e){n.onMessage(JSON.parse(e.data))},onerror:function(){console.log("error",arguments)},onclose:function(){console.log("onclose",arguments)}};var c=r.open(s)}})}if(n.hasLoadedChannels){r()}else{$.getScript("https://vysor-1026.appspot.com/_ah/channel/jsapi",r)}}if(window.chrome&&window.chrome.gcm){chrome.gcm.onMessage.addListener(function(e){n.onMessage(e.data)})}};n.prototype.sendGcm=function(e,t,n,o,i,r){if(!e)e=this.defaultSenderId;if(t.startsWith("web:")){$.ajax({type:"POST",url:"https://vysor-1026.appspot.com/send",data:JSON.stringify({channel:t.substring(4),data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",success:function(){}})}else{$.ajax({type:"POST",url:"https://gcm-http.googleapis.com/gcm/send",headers:{Authorization:"key="+this.senders[e]},data:JSON.stringify({to:t,data:{senderId:e,src:this.registrationId,srcPort:o,dstPort:n,type:i,message:JSON.stringify(r)}}),contentType:"application/json",dataType:"json",error:function(){console.log("gcm error",arguments)},success:function(){console.log("gcm",arguments)}})}};n.getKey=function(e,t,n){return n+":"+t+":"+e};n.prototype.setupPeerConnection=function(e,o,i,r,s,c){var a=window.RTCPeerConnection||window.webkitRTCPeerConnection;var d=new a(this.rtcc);var u;var l=function(t){this.sendGcm(o,i,r,s,e,{desc:c(),candidates:t})}.bind(this);d.onicecandidate=function(t){if(t.candidate==null)return;console.log(t.candidate);if(true){u=throttleTimeout(u,t.candidate,500,l)}else{this.sendGcm(o,i,r,s,e,{desc:c(),candidates:[t.candidate]})}}.bind(this);var f=n.getKey(i,r,s);var h=new t(d,f);h.manager=this;d.onsignalingstatechange=function(e){if(d.signalingState=="stable"){if(n.gcmRtcConnections[f]==h){}}else if(d.signalingState=="closed"){h.destroy()}};n.gcmRtcConnections[f]=h;return h};n.gcmPortCount=0;n.prototype.connect=function(e,t){var o=e.senderId;var i=e.registrationId;var r=e.port;var s=n.gcmPortCount++;var c;var a=this.setupPeerConnection("offer",o,i,r,s,function(){return c},t);var d=a.pc;function u(e){d.createOffer(e).then(function(e){c=e;d.setLocalDescription(e)})}if(!e.audio){var l=a.prepareChannel("pinger");l.onopen=function(){console.log("got rtc pinger");a.setupPinger(l);t(a)};a.listenSockets();u({})}else{navigator.webkitGetUserMedia({audio:true,video:false},function(e){d.addStream(e);d.onaddstream=function(e){console.log("got the remote stream");t(a,e)};u({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})},function(){console.error("audio fail",arguments);u({offerToReceiveAudio:true,offerToReceiveVideo:false,voiceActivityDetection:false})})}};n.gcmRtcListeners={};n.prototype.isListening=function(e){return n.gcmRtcListeners[e]!=null};n.prototype.stopListen=function(e){delete n.gcmRtcListeners[e]};n.prototype.listen=function(e,t){if(n.gcmRtcListeners[e]){console.log("already listening on gcm port "+e);return}n.gcmRtcListeners[e]={listener:this,listenCallback:t}};n.prototype.incoming=function(e,t,o,i,r,s){var c=n.getKey(t,o,i);var a=n.gcmRtcConnections[c];if(!a){var d;a=this.setupPeerConnection("answer",e,t,o,i,function(){return d});a.remoteDesc=new RTCSessionDescription(r.desc);var u=a.pc;u.ondatachannel=function(e){console.log("got rtc pinger");this.setupPinger(e.channel);s(a);this.listenSockets()}.bind(a);u.setRemoteDescription(a.remoteDesc,function(){u.createAnswer(function(e){d=e;u.setLocalDescription(e)},function(){console.error("answer error",arguments)})})}else if(!a.remoteDesc){a.remoteDesc=new RTCSessionDescription(r.desc);var u=a.pc;u.setRemoteDescription(a.remoteDesc)}else{}a.addCandidates(r)};window.GcmRtcSocket=e;window.GcmRtcManager=n})();(function(){function e(e,t){this.handle=e;this.iface=t;this.type="usb";for(var n in t.endpoints){n=t.endpoints[n];if(n.type=="bulk"){this.zero_mask=n.maximumPacketSize-1;if(n.direction=="in"){this.in=n}else{this.out=n}}}}e.prototype.destroy=function(){chrome.usb.releaseInterface(this.handle,this.iface.interfaceNumber,function(){chrome.runtime.lastError;chrome.usb.closeDevice(this.handle,function(){chrome.runtime.lastError})}.bind(this))};e.prototype.write=function(e,t){if(this.writing){if(!this.pendingWrites)this.pendingWrites=[];this.pendingWrites.push({data:e,callback:t});return}var n={direction:"out",endpoint:this.out.address,data:e};this.writing=true;chrome.usb.bulkTransfer(this.handle,n,function(e){chrome.runtime.lastError;this.writing=false;t(e);if(!this.pendingWrites)return;var n=this.pendingWrites.shift();if(!this.pendingWrites.length)this.pendingWrites=null;this.write(n.data,n.callback)}.bind(this))};e.prototype.read=function(e,t){var n={direction:"in",endpoint:this.in.address,length:e};chrome.usb.bulkTransfer(this.handle,n,function(e){chrome.runtime.lastError;t(e)})};function t(e){this.socket=e;this.zero_mask=(1<<30)-1;this.type="tcp";e.onClose=function(){var e=this.currentRead;if(e){delete this.currentRead;e({resultCode:-1})}}.bind(this)}t.prototype.destroy=function(){this.socket.destroy()};t.prototype.write=function(e,t){if(this.writing){if(!this.pendingWrites)this.pendingWrites=[];this.pendingWrites.push({data:e,callback:t});return}this.writing=true;this.socket.write(e,function(){this.writing=false;t({resultCode:0});if(!this.pendingWrites)return;var e=this.pendingWrites.shift();if(!this.pendingWrites.length)this.pendingWrites=null;this.write(e.data,e.callback)}.bind(this))};t.prototype.read=function(e,t){this.currentRead=t;this.socket.read(e,function(e){delete this.currentRead;t({resultCode:0,data:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)})})};function n(e,t){this.onConnected=t;this.transport=e;this.currentSocketId=0;this.sockets={};this.forwards={};this.maxPayload=n.MAX_PAYLOAD}n.prototype.fatal=function(e){console.log("fatal error",JSON.stringify(e));var t=this.onConnected;if(t){delete this.onConnected;t()}else if(this.onError){this.onError();delete this.onError}this.destroy()};n.prototype.destroy=function(){for(var e in this.sockets){e=this.sockets[e];e.dataReceived(null)}if(this.forwards){$.each(this.forwards,function(e,t){t.destroy()})}this.transport.destroy()};n.kCommandSYNC=1129208147,n.kCommandCNXN=1314410051,n.kCommandOPEN=1313165391,n.kCommandOKAY=1497451343,n.kCommandCLSE=1163086915,n.kCommandWRTE=1163154007,n.kCommandAUTH=1213486401;n.kAuthToken=1;n.kAuthSignature=2;n.kAuthRSAPublicKey=3;n.ADB_PROTOCOL_VERSION=16777216;n.ADB_VERSION=36;n.MAX_PAYLOAD=4096;n.checksum=function(e){e=new Uint8Array(e);var t=0;for(var n=0;n<e.byteLength;n++){t+=e[n]}return t&4294967295};n.prototype.sendMessage=function(e,t,o,i,r){if(!i){i=""}if(i.constructor.name=="String"){i=str2ab(i)}var s=true;if(!i.byteLength){s=false}if(e==n.kCommandAUTH&&t==n.kAuthSignature){s=false}if(e==n.kCommandWRTE){s=false}var c=i.byteLength;if(s){c++}if(s){var a=new ArrayBuffer(i.byteLength+1);var d=new Uint8Array(a);d.set(new Uint8Array(i));d[a.byteLength-1]=0;i=a}var u=new ArrayBuffer(24);var d=new DataView(u);d.setUint32(0,e,true);d.setUint32(4,t,true);d.setUint32(8,o,true);d.setUint32(12,c,true);d.setUint32(16,n.checksum(i),true);d.setUint32(20,e^4294967295,true);this.transport.write(u,function(e){if(e.resultCode){this.fatal(e)}if(!i.byteLength&&r){r()}}.bind(this));if(i.byteLength){this.transport.write(i,function(e){if(e.resultCode){this.fatal(e)}if(r){r()}}.bind(this))}};n.prototype.getKey=function(e){chrome.storage.local.get("adbkey",function(t){var n=t.adbkey;var o=new JSEncrypt({default_key_size:2048});if(!n){n=o.getPrivateKeyB64();o.setPrivateKey(n);chrome.storage.local.set({adbkey:n})}else{o.setPrivateKey(n)}e(o)})};n.prototype._convertToMinCrypt=function(e){var t=2048;var n=t/8/4;var o=BigInteger.ONE.shiftLeft(32);var i=e.n.clone();var r=BigInteger.ONE.shiftLeft(1).pow(t);var s=r.multiply(r).mod(i);var c=new Uint32Array(3+n*2);c[0]=n;c[1]=o.subtract(i.modInverse(o)).intValue();var a=n+2;for(var d=2,u=2+n;d<a;++d,++u){c[d]=i.mod(o).intValue();i=i.divide(o);c[u]=s.mod(o).intValue();s=s.divide(o)}c[c.length-1]=e.e;var l="";var f=new Uint8Array(c.buffer);for(var d=0;d<f.length;++d){var h=f[d].toString(16);if(h.length==1){l+="0"}l+=h}return hex2b64(l)+" adb@chrome"};n.prototype.sign=function(e,t){if(e==null){throw"AuthManager is not initialized"}var n=2048/8;var o=new Uint8Array(n);o[0]=0;o[1]=1;var i=[0,48,33,48,9,6,5,43,14,3,2,26,5,0,4,20];var r=n-i.length-t.byteLength;for(var s=2;s<r;s++){o[s]=255}o.set(new Uint8Array(i),r);r+=i.length;o.set(new Uint8Array(t),r);var c=new BigInteger(Array.apply([],o));return new Uint8Array(e.doPrivate(c).toByteArray()).buffer};function o(e){var t={};e=ab2str(e);var n=e.replace("device::","").split(";");for(var o in n){o=n[o];var i=o.split("=");if(i.length==2){t[i[0]]=i[1]}}return t}n.prototype.handleUnknown=function(e,t){console.log("no idea what this socket is.");this.sendMessage(n.kCommandCLSE,e,t)};n.prototype.receiveMessages=function(){this.transport.read(24,function(e){if(e.resultCode){this.fatal(e);return}var t=new DataView(e.data);var i=t.getUint32(0,true);var r=t.getUint32(4,true);var s=t.getUint32(8,true);var c=t.getUint32(12,true);var a=t.getUint32(16,true);var d=t.getUint32(12,true);var u=function(e){switch(i){case n.kCommandOPEN:if(this.onOpenSocket)this.onOpenSocket(e,r);break;case n.kCommandAUTH:console.log("auth:",this);this.getKey(function(t){if(this.sentSignature){var o=this._convertToMinCrypt(t.getKey());this.sendMessage(n.kCommandAUTH,n.kAuthRSAPublicKey,0,o);showNotification('Check your Android device and click "Allow USB Debugging".')}else{this.sentSignature=true;var i=this.sign(t.getKey(),e);this.sendMessage(n.kCommandAUTH,n.kAuthSignature,0,i,function(){})}}.bind(this));break;case n.kCommandOKAY:var t=r;var c=s;var a=this.sockets[c];if(!a){this.handleUnknown(c,t);return}var d=a.onConnected;if(d){delete a.onConnected;a.remoteId=t;d(a)}var u=a.pendingWrite;if(u){d=a.wrote;delete a.wrote;delete a.pendingWrite;a.write(u,d);return}d=a.wrote;if(d){delete a.wrote;d()}break;case n.kCommandCNXN:this.rawProperties=ab2str(e);this.properties=o(e);var d=this.onConnected;if(d){delete this.onConnected;d(this)}break;case n.kCommandWRTE:var t=r;var c=s;var a=this.sockets[c];if(!a){this.handleUnknown(c,t);return}if(!a.paused){this.sendMessage(n.kCommandOKAY,a.localId,a.remoteId)}a.dataReceived(new Uint8Array(e));break;case n.kCommandCLSE:var t=r;var c=s;var a=this.sockets[c];if(!a){console.log("asked to close unknown socket?");return}delete this.sockets[c];a.destroy();var d=a.onConnected;if(d){delete a.onConnected;d()}break;default:console.log("unknown command: ",i.toString(16),r,s,e);break}}.bind(this);if(!d){try{u(null)}finally{this.receiveMessages()}return}this.transport.read(d,function(e){if(e.resultCode){this.fatal(e);return}var o=e.data;if(n.checksum(o)!=t.getUint32(16,true)){this.receiveMessages();return}try{u(o)}finally{this.receiveMessages()}}.bind(this))}.bind(this))};n.prototype.forwardPort=function(e){var t=new Server;t.listen({port:e.fromPort,address:"127.0.0.1"},function(t){this.newSocket(e.to,function(e){if(e)Socket.stream(t,e);else t.destroy()}.bind(this))}.bind(this),function(){this.forwards[e.fromPort]=t}.bind(this))};n.prototype.newAdbSocket=function(e,t){var n;if(this.createSocket)n=this.createSocket(e,t);else n=new i(this,e,t);return n};n.prototype.newSocket=function(e,t){var o=++this.currentSocketId;this.sockets[o]=this.newAdbSocket(o,t);this.sendMessage(n.kCommandOPEN,o,0,e)};function i(e,t,n){if(!n){n=function(){}}this.device=e;this.localId=t;this.onConnected=n}i.prototype.write=function(e,t){if(this.pendingWrite||this.wrote){console.log("bad adb socket state, already writing");throw new Error("bad adb socket state, already writing")}var o=Math.min(this.device.transport.zero_mask,this.device.maxPayload);if(o<e.byteLength){this.pendingWrite=e.slice(o);e=e.slice(0,o)}else{this.pendingWrite=null}this.wrote=t;this.device.sendMessage(n.kCommandWRTE,this.localId,this.remoteId,e)};i.prototype.destroy=function(){this.device.sendMessage(n.kCommandCLSE,this.localId,this.remoteId);this.dataReceived(null)};i.prototype.buffered=Socket.prototype.buffered;i.prototype.dataReceived=Socket.prototype.dataReceived;i.prototype.read=Socket.prototype.read;i.prototype.pause=Socket.prototype.pause;i.prototype.resume=Socket.prototype.resume;i.prototype.unshift=Socket.prototype.unshift;i.prototype.onPause=function(){};i.prototype.onResume=function(){this.device.sendMessage(n.kCommandOKAY,this.localId,this.remoteId)};function r(t,o,i){console.log("connecting");var r=new n(new e(t,o),i);console.log("sending CNXN");r.sendMessage(n.kCommandCNXN,n.ADB_PROTOCOL_VERSION,n.MAX_PAYLOAD,"host::");console.log("starting receive loop");r.receiveMessages()}function s(e){var e=e||{};var t=e.port||5037;var n=e.start!==false;this.currentSocketId=0;this.pendingDevices={};this.port=t;this.adbDevices={};this.clients={};if(n){this.start()}}function c(){return(new Date).getTime()}s.prototype.start=function(){if(this.server){console.log("ADB Server started while already started");return}this.clients={};this.adbDevices={};this.pendingDevices={};this.refreshing={};var e=new Server;e.listen({port:this.port,address:"127.0.0.1"},function(e){var t=new a(this,e);var n=++this.currentSocketId;this.clients[n]=t;e.onClose=function(){delete this.clients[n]}.bind(this);t.receiveHeader()}.bind(this),function(t){if(t){console.log("adb server failed to listen: "+t);return}console.log("ADB Server started");this.server=e;this.refresh()}.bind(this))};s.prototype.isRunning=function(){return this.server!=null};s.prototype.kill=function(){this.server.destroy();this.server=null;this.refreshing={};for(var e in this.clients){e=this.clients[e];e.socket.destroy()}this.clients={};for(var t in this.adbDevices){t=this.adbDevices[t];t.destroy()}this.adbDevices={};this.pendingDevices={}};s.prototype.selectDevice=function(e){chrome.usb.getUserSelectedDevices({filters:[{interfaceClass:255,interfaceSubclass:66,interfaceProtocol:1}]},function(t){for(var n in t){n=t[n];this.refreshDevice(n,e)}}.bind(this))};s.prototype.withAdbDevice=function(e,t){e.onError=function(){delete this.adbDevices[e.serialno];this.internalOnDevicesChanged()}.bind(this);var n=function(n){e.serialno=n.trim();this.adbDevices[e.serialno]=e;console.log("found device: "+e.serialno);this.internalOnDevicesChanged();t(e)}.bind(this);if(e.serialno){n(e.serialno);return}e.newSocket("shell:getprop ro.serialno",function(e){readString(e,function(e){n(e)}.bind(this))}.bind(this))};s.prototype.tryDevice=function(e,t,n){var o=this.adbDevices;var i=this.pendingDevices;var s=this;function c(o){var c=o.interfaceNumber;if(i[c]){return false}i[c]=e;console.log("claiming:",JSON.stringify(e),JSON.stringify(o));chrome.usb.claimInterface(e,o.interfaceNumber,function(){console.log("claimed:",JSON.stringify(chrome.runtime.lastError));
r(e,o,function(e){if(!e){delete i[c];n();return}e.serialno=t;s.withAdbDevice(e,function(e){delete i[c];n(e)})})});return true}chrome.usb.listInterfaces(e,unsafeCallback(function(t){if(!t){console.log("unable list interfaces",JSON.stringify(chrome.runtime.lastError));if(n)n();return}console.log("got interfaces",JSON.stringify(t));var o=false;for(var i in t){i=t[i];if(i.interfaceClass==255&&i.interfaceSubclass==66&&i.interfaceProtocol==1){o|=c(i)}}if(!o){chrome.usb.closeDevice(e)}}))};s.prototype.refreshDevice=function(e,t){chrome.usb.openDevice(e,function(n){if(!n){console.log("unable to open device",JSON.stringify(chrome.runtime.lastError));if(t)t();return}this.start();this.tryDevice(n,e.serialNumber,function(n){if(n){n.usbDevice=e}t(n)})}.bind(this))};s.prototype.refresh=function(){if(!this.server){console.log("adb server refresh requested while server killed");return}var e=c();if(this.server.lastRefresh&&this.server.lastRefresh>e-1e4){return}this.server.lastRefresh=e;var t=chrome.runtime.getManifest().permissions.pop().usbDevices;$(t).each(function(e,t){var n=t.vendorId+"&"+t.productId;if(this.refreshing[n]){return}this.refreshing[n]=true;chrome.usb.findDevices({productId:t.productId,vendorId:t.vendorId},function(e){var o=e.length;if(!o){delete this.refreshing[n];return}console.log("found:",t,e);for(var i in e){console.log("trying:",e[i]);this.tryDevice(e[i],e[i].serialNumber,function(){o--;if(!o){delete this.refreshing[n]}}.bind(this))}}.bind(this))}.bind(this))};s.prototype.internalOnDevicesChanged=function(){for(var e in this.clients){e=this.clients[e];if(!e.tracking)continue;var t=e.getDevicesString();if(!t.length)t="0000\n";e.socket.write(str2ab(t),function(){})}};s.prototype.stop=function(){this.server.destroy()};function a(e,t){this.server=e;this.socket=t}a.prototype.resolveTransport=function(e,t){if(t){var n=this.server.adbDevices[t];if(!n)return"device not found";return n}var o=Object.keys(this.server.adbDevices);if(o>1){return"more than one device"}if(o==0){return"no devices connected"}for(var i in this.server.adbDevices){return this.server.adbDevices[i]}};a.prototype.write=function(e,t,n){if(!t){t="OKAY"}e=str2ab(e);var o=e.byteLength;var i=make4Len16(o);i=str2ab(t+i);var r=appendBuffer(new Uint8Array(i),new Uint8Array(e)).buffer;if(!n){n=function(){this.socket.destroy()}.bind(this)}this.socket.write(r,n)};a.prototype.getDevicesString=function(e){var e=e||{};var t=e.longformDevices;var n="";for(var o in this.server.adbDevices){o=this.server.adbDevices[o];n+=o.serialno+"\tdevice";if(t){if(o.transport.type=="usb")n+=" usb:"+o.transport.iface.interfaceNumber;else n+=" tpcip:"+"something";n+=" product:"+o.properties["ro.product.name"];n+=" model:"+o.properties["ro.product.model"];n+=" device:"+o.properties["ro.product.device"]}n+="\n"}return n};a.prototype.writeDevices=function(e,t){this.write(this.getDevicesString(e),null,t)};a.prototype.handlePayload=function(e){e=ab2str(e);var o=e.split(":");var i=e;var r;if(o[0]=="host-serial"){o[0]="host";r=o.splice(1,1)[0];if(Number.isInteger(parseInt(o[1]))){r+=":"+o.splice(1,1)[0]}}if(o.length>=2)i=o[0]+":"+o[1];switch(i){case"host:version":this.write(make4Len16(n.ADB_VERSION));break;case"host:devices-l":case"host:devices":var s=e=="host:devices-l";this.server.refresh();this.writeDevices({longformDevices:s});break;case"host:features":var a=this.resolveTransport(e,r);if(a.constructor.name=="String"){this.write(a,"FAIL");break}var d=a.properties.features;if(!d)d="";this.write(make4Len16(d));break;case"host:transport-usb":case"host:transport-any":var a=this.resolveTransport(e,r);if(a.constructor.name=="String"){this.write(a,"FAIL");break}this.transport=a;this.socket.write(str2ab("OKAY"),function(){});break;case"host:kill":this.server.kill();break;case"host:connect":if(o.length<3){this.write("need more arguments for connect <host>[:<port>]","FAIL");break}var u=o[2];var l=5555;if(o.length>3)l=Number.parseInt(o[3]);Socket.connect({host:u,port:l},function(e,o){if(!e){console.error("connect failed");this.write("unable to connect to "+u+" "+l+": "+o,"FAIL");return this}var i=new n(new t(e),function(e){this.server.withAdbDevice(e,function(){var e="connected to "+u+":"+l;console.log(e);this.write(e)}.bind(this))}.bind(this));i.serialno=u+":"+l;e.onClose=function(){i.fatal("socket closed")}.bind(this);i.sendMessage(n.kCommandCNXN,n.ADB_PROTOCOL_VERSION,n.MAX_PAYLOAD,"host::");i.receiveMessages()}.bind(this));break;case"host:track-devices":this.tracking=c();this.writeDevices({},function(){});break;case"host:forward":var f=o.join(":").substring(i.length+1).split(";");var h=f[0].split(":");var p=parseInt(h[1]);var a=this.resolveTransport(e,r);if(a.constructor.name=="String"){this.write(a,"FAIL");break}a.forwardPort({fromPort:p,to:f[1]});this.socket.write(str2ab("OKAYOKAY"),function(){}.bind(this));break;default:if(this.transport){var a=this.transport;a.newSocket(e,function(e){if(!e){this.socket.write(str2ab("OKAY"),function(){this.socket.destroy()}.bind(this));return}this.socket.write(str2ab("OKAY"),function(){});Socket.stream(e,this.socket)}.bind(this));return}var v="host:transport:";if(e.startsWith(v)){var r=e.substr(v.length);var m=this.server.adbDevices[r];if(!m){this.write("device not found","FAIL");return}this.transport=m;this.socket.write(str2ab("OKAY"),function(){});break}console.log("unknown request: "+e);this.write("unknown command: "+e,"FAIL");var g=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:"/icon.png",title:g,message:g+"'s adb server encountered an unknown adb command.\nYou may want to close "+g+" and start your adb binary manually."});break}this.receiveHeader()};a.prototype.receivePayload=function(e){var t=parseInt(ab2str(e),16);this.socket.read(t,this.handlePayload.bind(this))};a.prototype.receiveHeader=function(){this.socket.read(4,this.receivePayload.bind(this))};window.AdbDevice=n;window.AdbServer=s;window.AdbTcpTransport=t})();(function(){var e={};e.sendHostCommand=function(e,t){Socket.connect({host:"127.0.0.1",port:5037},function(n){if(!n){t();return}e=make4Len16(e.length)+e;n.read(4,function(e){if(ab2str(e)!="OKAY"){n.destroy();t();return}n.read(4,function(e){var o=ab2str(e);e=parseInt(o,16);if(e==0||o=="OKAY"){t(n,new ArrayBuffer(0));return}n.read(e,function(e){t(n,e)})})});n.write(str2ab(e),function(){})})};e.devices=function(t){var n={};function o(e){var t=e;e=e.replace("\t"," ");var o=e.indexOf(" ");if(o==-1)return;var i=e.substring(0,o);e=e.substring(o).trim();var r;while(r!=e){r=e;e=e.replace("  "," ")}var s={};var c=e.indexOf(" ");if(c==-1)c=e.length;var a=e.substring(0,c);e=e.substring(c+1);while(e.length){o=e.indexOf(":");if(o==-1)break;var d=e.substring(0,o);var u=e.substring(o+1);var l=u.indexOf(" ");var f=u.indexOf(":");var h;if(l==-1||f==-1){h=u;e=""}else{while(l!=-1&&l<f){h=u.substring(0,l);e=u.substring(l+1);l=u.indexOf(" ",l+1)}}s[d]=h}var p;if(!s["model"])p=i;else p=s["model"].replace("_"," ");n[i]={name:p,status:a,properties:t}}e.sendHostCommand("host:devices-l",function(e,i){if(!e){t();return}e.destroy();i=ab2str(i);console.log("ADB devices:",i);i=i.trim();var r=i.split("\n");for(var s in r){s=r[s];o(s)}t(n)})};e.killServer=function(t){e.sendHostCommand("host:kill-server",function(e,n){if(!e){t();return}e.destroy();n=ab2str(n);if(t)t()})};e.sendClientCommand=function(e,t){var n=e.command;var o=e.serialno;Socket.connect({host:"127.0.0.1",port:5037},function(e){if(!e){t();return}e.read(4,function(o){var i=ab2str(o);if(i!="OKAY"){e.destroy();t(null);return}var r=n;r=make4Len16(r.length)+r;e.read(4,function(n){var o=ab2str(n);if(o!="OKAY"){e.destroy();t(null);return}t(e)});e.write(str2ab(r),function(){})});var i="host:transport:"+o;i=make4Len16(i.length)+i;e.write(str2ab(i),function(){})})};e.shell=function(t,n){var o=t.command;var i=t.serialno;e.getOrCreateSockFactory(t).newSocket("shell:"+o,function(e){if(!e){n();return}readString(e,function(e){n(e)})})};e.forward=function(t,n){var o="host-serial:"+t.serialno+":forward:"+t.from+";"+t.to;e.sendHostCommand(o,function(e,t){if(e)e.destroy();n(e,t)})};function t(){}t.MKID=function(e,t,n,o){return e.charCodeAt(0)|t.charCodeAt(0)<<8|n.charCodeAt(0)<<16|o.charCodeAt(0)<<24};t.ID_RECV=t.MKID("R","E","C","V");t.ID_SEND=t.MKID("S","E","N","D");t.ID_DONE=t.MKID("D","O","N","E");t.ID_DATA=t.MKID("D","A","T","A");t.DATA_MAX=64*1024;e.pull=function(n,o){var i=n.file;var r=n.serialno;var s=n.fileEntry;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){o();return}s.createWriter(function(n){var r=new ArrayBuffer(8);var c=new DataView(r);c.setUint32(0,t.ID_RECV,true);c.setUint32(4,i.length,true);e.write(r,function(){e.write(str2ab(i),function(){function i(t){e.read(t,function(e){n.write(new Blob([e]))})}n.onwriteend=function(e){r()};function r(){e.read(8,function(n){var r=new DataView(n.buffer,n.byteOffset,n.byteLength);var c=r.getUint32(0,true);if(c==t.ID_DATA){var a=r.getUint32(4,true);i(a);return}e.destroy();if(c==t.ID_DONE){o(s);return}o()})}r()})})})})};e.createSocketFactory=function(t){return{newSocket:function(n,o){e.sendClientCommand({serialno:t,command:n},o)}}};e.getOrCreateSockFactory=function(t){return t.socketFactory||e.createSocketFactory(t.serialno)};e.push=function(n,o){var i=n.file;var r=n.serialno;var s=n.socket;e.getOrCreateSockFactory(n).newSocket("sync:",function(e){if(!e){o();return}var n=new ArrayBuffer(8);var r=new DataView(n);var c=i+",0644";r.setUint32(0,t.ID_SEND,true);r.setUint32(4,c.length,true);e.write(n,function(){e.write(str2ab(c),function(){var n;var i=true;s.onClose=function(){var n=new ArrayBuffer(8);var i=new DataView(n);i.setUint32(0,t.ID_DONE,true);i.setUint32(4,0,true);e.write(n,function(){e.read(8,function(){o()})})};function r(){s.read(function(e){if(e.byteLength>t.DATA_MAX){var n=e.subarray(t.DATA_MAX);e=e.subarray(0,t.DATA_MAX);s.unshift(n)}c(e)})}function c(n){var o=new ArrayBuffer(8);var i=new DataView(o);i.setUint32(0,t.ID_DATA,true);i.setUint32(4,n.byteLength,true);e.write(o,function(){var t=n.buffer;if(n.byteOffset||n.length!=t.byteLength){t=t.slice(n.byteOffset,n.byteOffset+n.byteLength)}e.write(t,function(){r()})})}r()})})})};window.Adb=e})();(function(){function e(e,t){this.transport=e;this.sockets={};this.currentSocketId=0;this.maxPayload=t||AdbDevice.MAX_PAYLOAD}e.prototype.start=function(e){var t=str2ab(e,undefined,true);this.sendMessage(AdbDevice.kCommandCNXN,AdbDevice.ADB_PROTOCOL_VERSION,this.maxPayload,t);this.receiveMessages()};e.prototype.fatal=function(e){console.log("fatal error",e);var t=this.onClose;if(t){delete this.onClose;t()}};e.prototype.sendMessage=AdbDevice.prototype.sendMessage;e.prototype.receiveMessages=AdbDevice.prototype.receiveMessages;e.prototype.handleUnknown=AdbDevice.prototype.handleUnknown;e.prototype.newAdbSocket=AdbDevice.prototype.newAdbSocket;e.prototype.destroy=AdbDevice.prototype.destroy;e.prototype.onOpenSocket=function(e,t){if(this.openSocket){var n=++this.currentSocketId;var o=this.newAdbSocket(n);o.remoteId=t;this.sockets[n]=o;this.sendMessage(AdbDevice.kCommandOKAY,n,t);this.openSocket(ab2str(e),o)}};window.AdbDaemon=e})();(function(){function e(e,t,n){$.ajax({url:e,dataType:"binary",responseType:"arraybuffer",success:function(e){var o=new Uint8Array(e);var i=new DummySocket(o);var r="/data/local/tmp/apk"+(new Date).getTime()+".apk";Adb.push({serialno:t,file:r,socket:i},function(){Adb.shell({command:"pm install -r "+r,serialno:t},n)})}})}function t(e,t,n){Adb.shell({command:"pm path "+t,serialno:e},function(e){if(e==""||!e){n(null);return}var t=e.match(/package:\/.*?[\r\n]/);if(!t||!t.length){n(null);return}e=t[0];e=e.replace("package:","").trim();n(e)})}function n(e,t,n,o,i){if(!i)i=Adb.shell;Adb.shell({command:"ls -l /system/bin/app_process*",serialno:e},function(r){var s="/system/bin/app_process";if(r&&r.indexOf("app_process32")!=-1){s+="32"}i({command:'sh -c "CLASSPATH='+t+" "+s+" /system/bin "+n+'"',serialno:e},o)})}window.AdbUtils={runMain:n,installApk:e,getApkPath:t}})();(function(){var e=function(e){this.authorization=e};e.prototype.shorten=function(e,t){$.ajax({type:"POST",url:"https://www.googleapis.com/urlshortener/v1/url?key="+this.authorization,data:JSON.stringify({longUrl:e}),contentType:"application/json",dataType:"json",success:function(e){t(e.id)}})};window.Googl=e})();function verifySignature(e,t,n,o,i){o=base64ToArrayBuffer(o);n=str2ab(n);window.crypto.subtle.importKey("jwk",{kty:"RSA",e:e,n:t,alg:"RS1"},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},true,["verify"]).then(function(e){window.crypto.subtle.verify({name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-1"}},e,o,n).then(function(e){if(!e){i("invalid signature");return}i()}).catch(function(e){i("failure to verify",e)})}).catch(function(e){i("key import failed",e)})}(function(){function e(){this.licensed=false;this.licenseCached=false}e.prototype.refresh=function(e){this.refreshInternal(e).async()};e.prototype.refreshInternal=function*(e){var t;var n=function(){if(this.isLicensed()){var n=chrome.app.window.get("purchase");if(n!=null){n.close();showNotification("Vysor subscription is active. Thank you for your support!")}}if(t)return;t=true;if(e)e();if(this.globalRefresh)this.globalRefresh()}.bind(this);var o=false;var i=false;var r=false;var s=false;var c;var a;var d;var u=function(e,t){if(!t.licensed)return;if(e!=t.email){console.log("email mismatch");return}console.log("enterprise license retrieved");this.licensed=true}.bind(this);var l=function(e,t){if(t.sandbox!=o){console.log("sandbox mismatch");return}if(e!=t.buyer_id){console.log("id mismatch");return}if(t.seller_id!="koushd@gmail.com"){console.log("seller mismatch");return}$.each(t.orders,function(e,t){console.log("paypal purchase status",t.is_purchased);if(t.is_purchased){console.log("clockwork license retrieved");this.licensed=true}}.bind(this))}.bind(this);var f=function(e){var t=0;$.each(e,function(e,n){console.log("subscription status",n.sku,n.state);if(n.state=="ACTIVE"){console.log("chrome license retrieved");this.licensed=true;t=Math.max(t,n.createdTime)}}.bind(this));return t}.bind(this);var h=function*(){if(s)return;var e=yield chrome.identity.getAuthToken({interactive:false,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]},yield);if(!e){chrome.runtime.lastError;console.log("No auth token for enterprise licensing");return}try{var t=yield $.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo",headers:{Authorization:"Bearer "+e},dataType:"json",error:yield Error,success:yield Success});var o=t.id;var i=t.email;try{var t=yield $.ajax({url:"https://vysor-1026.appspot.com/license",headers:{Authorization:"Bearer "+e},dataType:"json",success:yield Success,error:yield Error});var r=JSON.parse(t.signed_data);u(i,r);if(!this.isLicensed())return;yield chrome.storage.local.set({cachedEnterpriseLicense:t},yield);this.licenseCached=true;n()}catch(c){chrome.identity.removeCachedAuthToken({token:e},function(){});console.log("Error communicating with vysor enterprise",c)}}catch(c){chrome.identity.removeCachedAuthToken({token:e},function(){});console.log("Unable to get email for enterprise",c)}}.bind(this);var p=function*(){if(i)return;var e=yield chrome.identity.getAuthToken({interactive:false,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]},yield);if(!e){chrome.runtime.lastError;console.log("No auth token for clockwork billing");return}try{var t=yield $.ajax({url:"https://www.googleapis.com/oauth2/v1/userinfo",headers:{Authorization:"Bearer "+e},dataType:"json",error:yield Error,success:yield Success});var r=t.id;var s="https://clockworkbilling.appspot.com/api/v1/purchase/koushd@gmail.com/"+r+"?sandbox="+o+"&nonce="+Date.now();try{var t=yield $.ajax({url:s,dataType:"json",error:yield Error,success:yield Success});var c=JSON.parse(t.signed_data);l(r,c);if(!this.isLicensed())return;yield chrome.storage.local.set({cachedClockworkLicense:t},yield);this.licenseCached=true;n()}catch(a){console.log("error requesting purchases")}}catch(a){chrome.identity.removeCachedAuthToken({token:e},function(){});console.log("Unable to get buyer id for clockworkbilling",a)}}.bind(this);var v=function*(){if(r)return;var e;try{e=yield google.payments.inapp.getPurchases({parameters:{env:"prod"},success:yield Success,failure:yield Error});throw new Error("purposely fail")}catch(t){console.error("failed to query license from chrome store",t);if(!c){console.log("falling back to server proxied query.");try{yield this.cacheLicense(yield,{interactive:false});yield*y()}catch(t){console.error("failed to do fallback server check",t)}}return}f(e.response.details);if(!this.isLicensed())return;n();console.log("Caching Vysor license.");yield this.cacheLicense(yield,{interactive:false});if(this.isLicenseCached()&&this.globalRefresh)this.globalRefresh()}.bind(this);var m=4;var g=m/2;var y=function*(){if(r)return;var e=yield chrome.storage.local.get("cachedLicense",yield);if(!e.cachedLicense)return;var t=yield chrome.identity.getProfileUserInfo(yield);if(!t){console.log("unable to retrieve user info");return}var o=yield verifySignature("AQAB","vMGBBmLcMO4lOmg-YAHq2DjZKHTaW-xs9KPNXU_zKJ7ZhFhWH3I6skF9ZO8lKeXOSwVEIW4HVMa7m16S6WTrUw",e.cachedLicense.signed_data,e.cachedLicense.signature,yield);if(o){console.error(o);return}var i=JSON.parse(e.cachedLicense.signed_data);if(i.date>Date.now()){console.log("cached license date from future?");return}if(i.date+u*24*60*60*1e3<Date.now()){console.log("cached license is expired.");return}if(t.id!=i.userinfo.id){console.log("id mismatch");return}c=true;var s=f(i.payments);if(!this.isLicensed())return;var a=new Date-new Date(s);var d=a/1e3/60/60/24;var u;if(d<14)u=4;else u=Math.min(30,4+(d-14)/7);console.log("cached license is valid for "+(i.date+u*24*60*60*1e3-Date.now())/(60*60*1e3)+" hours");this.licenseCached=true;n();if(i.date+g*24*60*60*1e3<Date.now())yield*v()}.bind(this);var w=function*(){if(i)return;var e=yield chrome.storage.local.get("cachedClockworkLicense",yield);if(!e.cachedClockworkLicense)return;var t=yield chrome.identity.getProfileUserInfo(yield);if(!t){console.log("unable to retrieve user info");return}var o=yield verifySignature("AQAB","vMGBBmLcMO4lOmg-YAHq2DjZKHTaW-xs9KPNXU_zKJ7ZhFhWH3I6skF9ZO8lKeXOSwVEIW4HVMa7m16S6WTrUw",e.cachedClockworkLicense.signed_data,e.cachedClockworkLicense.signature,yield);if(o){console.error(o);return}var r=JSON.parse(e.cachedClockworkLicense.signed_data);if(r.timestamp+m*24*60*60*1e3<Date.now()){console.log("cached license is expired.");return}if(r.timestamp>Date.now()){console.log("cached license date from future?");return}a=true;l(t.id,r);if(!this.isLicensed())return;console.log("cached clockwork license is valid for "+(r.timestamp+m*24*60*60*1e3-Date.now())/(60*60*1e3)+" hours");this.licenseCached=true;n();if(r.timestamp+g*24*60*60*1e3<Date.now())yield*p()}.bind(this);var b=function*(){if(s)return;var e=yield chrome.storage.local.get("cachedEnterpriseLicense",yield);if(!e.cachedEnterpriseLicense)return;var t=yield chrome.identity.getProfileUserInfo(yield);if(!t){console.log("unable to retrieve user info for enterprise");return}var o=yield verifySignature("AQAB","hDuGsIhbjLYXteQX3F3KNriQHwUSZurS5voCkdpA1733A65pqtGOrk9g_yLiF94_vSK0VmL-4stq7WAYEbn6nw",e.cachedEnterpriseLicense.signed_data,e.cachedEnterpriseLicense.signature,yield);if(o){console.error(o);return}var i=JSON.parse(e.cachedEnterpriseLicense.signed_data);if(i.timestamp+m*24*60*60*1e3<Date.now()||i.timestamp<1467748842890){console.log("cached enterprise license is expired.");w();return}if(i.timestamp>Date.now()){console.log("cached enterprise license date from future?");return}d=true;u(t.email,i);if(!this.isLicensed())return;console.log("cached enterprise license is valid for "+(i.timestamp+m*24*60*60*1e3-Date.now())/(60*60*1e3)+" hours");this.licenseCached=true;n();if(i.timestamp+g*24*60*60*1e3<Date.now())yield*h()}.bind(this);yield*b();if(this.isLicensed())return;yield*w();if(this.isLicensed())return;yield*y();if(this.isLicensed())return;yield*v();if(this.isLicensed())return;yield*p();if(this.isLicensed())return;yield*h();if(this.isLicensed())return;n()};e.prototype.cacheLicense=function(e,t){if(!t){t={interactive:true}}chrome.identity.getAuthToken(t,function(n){if(!n){chrome.runtime.lastError;if(t.interactive)showNotification("Unable to get auth token: "+chrome.runtime.lastError);return}$.ajax({type:"post",url:"https://clockworkbilling.appspot.com/api/v1/verify/google/koushd@gmail.com",data:{token:n,item:chrome.runtime.id},dataType:"json",success:function(t){this.licenseCached=true;chrome.storage.local.set({cachedLicense:t},e)}.bind(this),error:function(t,o){chrome.identity.removeCachedAuthToken({token:n},function(){});if(e)e(o)}})}.bind(this))};e.prototype.isLicensed=function(){return this.licensed};e.prototype.isLicenseCached=function(){return this.licenseCached};e.prototype.startPurchase=function(){chrome.app.window.create("purchase.html",{id:"purchase",innerBounds:{minWidth:800,minHeight:840}},function(e){this.refresh();e.contentWindow.refreshLicenseManager=function(){chrome.storage.local.remove(["cachedLicense","cachedClockworkLicense","cachedEnterpriseLicense"],function(){this.refresh()}.bind(this))}.bind(this)}.bind(this))};window.LicenseManager=e})();function GcmDevice(e,t,n){this.adbSocketFactory=e;this.conn=n;this.conn.openSocket=this.openSocket.bind(this);var o=t.properties.substring(t.properties.indexOf("product")).replace(/ /g,";").replace("device","ro.product.device").replace("model","ro.product.model").replace("product","ro.product.name").replace(/:/g,"=");this.properties="device::"+o+";"}GcmDevice.prototype.openSocket=function(e,t){if(this.onOpenSocket&&this.onOpenSocket(e,t))return;if(e=="properties"){var n=this.properties;t.write(str2ab(n),function(){console.log("sent properties",n);t.destroy()});return}this.adbSocketFactory.newSocket(e,function(n){if(!n){console.log("unable to execute adb proxy command?",e);t.destroy();return}Socket.stream(n,t,function(){})})};function getWhitelist(e){chrome.storage.local.get("whitelist",function(t){var n={};if(!t.whitelist||t.whitelist.constructor.name!="Array"){e(n);return}$.each(t.whitelist,function(e,t){n[t]=true});e(n)})}function saveWhitelist(e,t){chrome.storage.local.set({whitelist:Object.keys(e)},t)}function addToWhitelist(e,t){getWhitelist(function(n){n[e]=true;saveWhitelist(n,t)})}function clearWhitelist(){chrome.storage.local.remove("whitelist")}function isWhitelisted(e,t){chrome.storage.local.get(["whitelist","openServer"],function(n){if(n.openServer){t(true);return}var o={};if(!n.whitelist||n.whitelist.constructor.name!="Array"){t(false);return}$.each(n.whitelist,function(e,t){o[t]=true});t(o[e])})}(function(){var e=new AdbServer({start:false});window.adbServer=e;var t;var n;var o={};var i={};var r={};var s;var c=analytics.getService("vysor_app");var a=c.getTracker("UA-4956323-6");var d="software";var u=new LicenseManager;u.globalRefresh=function(){v();p()};u.refresh();function l(e){if(!s)return;var t=$(s.contentWindow.document).find("#notificationModal");var n=t.find("#modal-ok");var o=t.find("#modal-cancel");n.unbind("click");o.unbind("click");e.cancelButton=e.cancelButton||"Cancel";e.okButton=e.okButton||"OK";e.title=e.title||"";e.body=e.body||"";if(e.hideCancel)o.hide();else o.show();n.text(e.okButton);o.text(e.cancelButton);t.find("#modal-title").text(e.title);t.find("#modal-body").text(e.body);n.click(function(){if(e.ok)e.ok();s.contentWindow.hideModal()});if(e.cancel)e.click(e.cancel);s.contentWindow.goModal();if(e.duration){setTimeout(function(){s.contentWindow.hideModal()},e.duration)}}function f(e,t){e=e||chrome.runtime.getManifest().name;l({title:e,body:t,duration:5e3,hideCancel:true})}function h(){showNotification("Chrome GCM Service is unavailable. Try restarting Chrome?")}function p(){if(!u.isLicensed()||!s)return;$(s.contentWindow.document).find("#purchase").hide();$(s.contentWindow.document).find("#vysor-version").text("Vysor Pro Version "+chrome.runtime.getManifest().version);$(s.contentWindow.document).find(".navbar-brand").text("Vysor Pro");if(u.isLicenseCached())$(s.contentWindow.document).find("#login-container").hide();else $(s.contentWindow.document).find("#login-container").show()}function v(){if(!u.isLicensed())return;if(!s)return;chrome.storage.local.get("bitrate",function(e){var t=$(s.contentWindow.document).find("#bitrate")[0];if(!t)return;t.selectedIndex=e.bitrate})}function m(){if(!s)return;if(!n){$(s.contentWindow.document).find("#vysor-share-server-status").hide();$(s.contentWindow.document).find("#whitelist-count").hide()}else{$(s.contentWindow.document).find("#whitelist-count").show();getWhitelist(function(e){$(s.contentWindow.document).find("#whitelist-count a").text(Object.keys(e).length+" user(s) can access this server.").click(function(e){chrome.app.window.create("whitelist.html",{id:"whitelist",innerBounds:{width:768,height:512,minWidth:768,minHeight:512}},function(e){e.onClosed.addListener(function(){m()})})})});$(s.contentWindow.document).find("#vysor-share-server-status").show();$(s.contentWindow.document).find("#vysor-share-server-status").html("Vysor is sharing your devices: "+'<a href="#">'+n+"</a>");var e=$(s.contentWindow.document).find("#vysor-share-server-status a");e.click(function(){copyTextToClipboard(n);var e=chrome.runtime.getManifest().name;f("Copied "+e+" Share Server URL to clipboard.",n)})}}function g(e,t,n){return function(){if(!u.isLicensed()){l({title:"Vysor Pro",body:"The "+e+" feature is only avaiable to Vysor Pro users.",okButton:"Upgrade",ok:function(){u.startPurchase()}});if(n)n.apply(this,arguments);return}t.apply(this,arguments)}}function y(e,t){if(!u.isLicensed()){showNotification("The "+e+" feature is only avaiable to Vysor Pro users.");u.startPurchase();return}t()}var w;chrome.storage.local.get("vysorForceSocket",function(e){w=e.vysorForceSocket});function b(e,t){var n=chrome.app.window.get(e);if(!n)return;$(n.contentWindow.document).find("#loading-text").html(t)}function k(e,t){b(e,"Installing Vysor APK...");AdbUtils.installApk("/Vysor-release.apk",e,t)}function S(e,n,o){b(e,"Connecting...");function i(i){var r=Math.round(Math.random()*(1<<30)).toString(16);var s="echo -n "+r+" > /data/local/tmp/vysor.pwd ; chmod 600 /data/local/tmp/vysor.pwd";AdbUtils.runMain(e,i,"com.koushikdutta.vysor.Main password="+r+" keyboard="+t,function(t){Adb.shell({serialno:e,command:'sh -c "'+s+'"'},function(e){Socket.eat(t);o(n,r)})},function(e,t){e.command="shell:"+e.command;Adb.sendClientCommand(e,t)})}function r(t){b(e,"Connecting...");AdbUtils.getApkPath(e,"com.koushikdutta.vysor",function(n){if(!n){t();return}AdbUtils.runMain(e,n,"com.koushikdutta.vysor.ProtocolVersionMain",function(e){var o=e.match(/vysor-io-.*?[\r\n]/);if(!o||!o.length){t(null);return}e=o[0];if(e)e=e.trim();console.log("protocol version: "+e);if(e!="vysor-io-27")t(null);else t(n)})})}r(function(t){if(!t){console.log("installing apk");k(e,function(t){r(function(n){if(!n){if(!t)t="";showNotification("Error installing APK:\n"+t.trim());C(e);return}i(n)})});return}i(t)})}function C(e){var t=chrome.app.window.get(e);if(t)t.close()}var A=53516;function D(e,t){var n=A++;Adb.forward({from:"tcp:"+n,to:"tcp:53516",serialno:e},function(){S(e,n,t)})}function L(t,n,i,r){if(o[n]){console.log("vysor socket fast path");t.contentWindow.adbSocketFactory=o[n]}else if(e.isRunning()){console.log("adb server socket path");t.contentWindow.adbSocketFactory=e.adbDevices[n]}else{console.log("adb client socket path");t.contentWindow.adbSocketFactory=Adb.createSocketFactory(n)}t.contentWindow.openList=P;t.contentWindow.port=i;t.contentWindow.password=r;t.contentWindow.serialno=n;t.contentWindow.tracker=a;t.contentWindow.acceleration=d;t.contentWindow.Function.prototype.libind=function(e,t){return function(){if(!u.isLicensed()){showNotification("The "+e+" is only avaiable to Vysor Pro users.");u.startPurchase();return}this.apply(t,arguments)}.bind(this)}}function W(){setTimeout(function(){if(!chrome.app.window.getAll().length){chrome.runtime.reload()}},5e3)}window.openTutorial=function(){chrome.app.window.create("screen.html",{id:"tutorial",bounds:{width:576,height:1024}},function(e){a.sendEvent("open-tutorial");e.contentWindow.openList=P;e.contentWindow.onload=function(){e.contentWindow.docReady()}})};function I(e,t,n){_();var o=chrome.app.window.get(e);if(o){o.show();if(t){D(e,function(t,n){L(o,e,t,n);o.contentWindow.connectionReady()})}return}chrome.app.window.create("screen.html",{id:e,bounds:{width:576,height:1024}},function(t){var o;t.onClosed.addListener(o=function(){t.onClosed.removeListener(o);W();if(t.contentWindow.h264Socket){console.log("cleaning up h264 socket");t.contentWindow.h264Socket.destroy();t.contentWindow.h264Socket=null}if(t.contentWindow.inputWebSocket){console.log("cleaning up input websocket");t.contentWindow.inputWebSocket.close();t.contentWindow.inputWebSocket=null}});t.contentWindow.onload=function(){L(t,e,null,null);t.contentWindow.docReady();if(n)n(t);if(!Y[e]){console.log("Vysor requested for",e,"which is not available yet");return}D(e,function(n,o){L(t,e,n,o);t.contentWindow.connectionReady();Adb.shell({command:"am start com.koushikdutta.vysor/.TipsActivity",serialno:e},function(){})})}})}function O(e){var t=[5e5,75e4,1e6,15e5,2e6];var n=t[e];var o=chrome.app.window.getAll();for(var i in o){i=o[i];if(!i.contentWindow.sendEvent){console.log(i.id,"not a device window");continue}console.log(i.id,"updating device window");i.contentWindow.sendEvent({type:"bitrate",bitrate:n})}}function T(){n=null;if(B)B.stopListen("share");m()}function U(e,t,n){if(!e.devices[t])return;if(e.gcmConn.gcmConns[t])e.gcmConn.gcmConns[t].destroy();var o;var i=e.gcmConn.gcmConns[t]={farm:true,newSocket:function(n,i){if(o)return;e.gcmConn.newSocket(t+":"+n,i)},destroy:function(){o=true;if(e.gcmConn.gcmConns[t]==i)delete e.gcmConn.gcmConns[t];delete Y[i.serialno];e.gcmConn.newSocket("close:"+t,function(e){if(e)e.destroy()});var n=i.onClose;if(n){delete i.onClose;n()}}};M(function(e){e(i)},n)}var R;function E(e,t){e=new URL(e);var n=e.hash.replace("#","");function o(e){if(!B){h();return}B.connect({senderId:"64148182473",registrationId:e.registration,port:"share"},function(o){a.sendEvent("connected-device-farm");var i=r[n];var s;if(i){i.gcmConn.destroy()}var c=r[n]={info:e,gcmConn:o};o.gcmConns={};function d(){o.newSocket("devices:",function(e){readString(e,function(e){var t=JSON.parse(e);var n=t.devices;var i=t.sharedDevices;if(!c.devices){c.devices=n}else{$.each(Object.keys(n),function(e,t){delete c.devices[t]});$.each(Object.keys(c.devices),function(e,t){var n=o.gcmConns[t];if(n)n.destroy()});c.devices=n}c.sharedDevices=i;Q()})})}o.openSocket=function(e,n){if(e.startsWith("challenge:")){console.log("received challenge",e);var i=e.split(":")[1];$.ajax({type:"post",url:"https://vysor-1026.appspot.com/verifyauth",headers:{Authorization:"Bearer "+t},data:{nonce:i},dataType:"json",success:function(e){R=JSON.parse(e.signed_data);console.log("sending challenge response",e);writeLine(n,e,function(){readLine(n,function(e){if(e=="ok")d();n.destroy()})})},error:function(e,t){showNotification("Unable to verify identity");n.destroy()}})}else if(e.startsWith("close:")){n.destroy();var r=e.split(":")[1];var c=o.gcmConns[r];if(!c){console.log("can't close unknown subconn");return}c.destroy()}else if(e.startsWith("tracker:")){console.log("got tracker socket");s=n;function a(){s.read(function(){d();a()})}a()}else{console.log("got unknown socket request",e);n.destroy()}};o.onClose=function(){if(r[n]==c)delete r[n];$.each(Object.keys(o.gcmConns),function(e,t){var n=o.gcmConns[t];if(n)n.destroy()})};console.log("Connection to device farm established",o)})}$.ajax({url:"https://vysor-1026.appspot.com/gcm/"+n,dataType:"json",success:o,error:function(e,t){showNotification("Unable to find server: "+t)}})}function x(){T();chrome.identity.getAuthToken({interactive:true,scopes:["https://www.googleapis.com/auth/userinfo.profile"]},function(e){if(!e){var t=chrome.runtime.getManifest().name;
f(t+" Share Server","Unable to get Auth Token.");$(s.contentWindow.document).find("#share-all-check").prop("checked",false);return}if(!B){h();return}$.ajax({type:"post",url:"https://vysor-1026.appspot.com/gcm",headers:{Authorization:"Bearer "+e},data:{registration:B.registrationId},dataType:"json",success:function(e){console.log(e);n="https://vysor.clockworkmod.com/server#"+e.id;m();var t=chrome.runtime.getManifest().name;f("Copied "+t+" Share Server URL to clipboard.",n);copyTextToClipboard(n)}.bind(this),error:function(e,t){showNotification("Unable to register server: "+t);T()}});var r;var c=[];function a(){r=throttleTimeout(r,null,500,function(){$.each(c,function(e,t){if(!t.trackerSocket)return;t.trackerSocket.write(str2ab("0000\n"),function(){})});Q()})}var d;B.listen("share",function(e){var t;var n;var r;var s={};var u=Math.round(Math.random()*(1<<30)).toString(16)+Math.round(Math.random()*(1<<30)).toString(16);e.onClose=function(){var t=c.indexOf(e);if(t!=-1)c.splice(t,1);if(e.trackerSocket){e.trackerSocket.destroy();delete e.trackerSocket}$.each(Object.keys(s),function(e,t){var n=s[t];n.destroy()})};e.newSocket("challenge:"+u,function(o){readLine(o,function(i){console.log("received challenge response",i);var s=JSON.parse(i);function a(){writeLine(o,"fail",function(){o.destroy()})}verifySignature("AQAB","hDuGsIhbjLYXteQX3F3KNriQHwUSZurS5voCkdpA1733A65pqtGOrk9g_yLiF94_vSK0VmL-4stq7WAYEbn6nw",s.signed_data,s.signature,function(i){if(i){console.log("Remote user failed to authorize",i);a();return}n=JSON.parse(s.signed_data);if(n.nonce!=u){console.log("Remote user failed to authorize, mismatched nonce");a();return}function d(){function i(){c.push(e);t=true;writeLine(o,"ok",function(){o.destroy()});showNotification("Vysor is sharing Android devices with "+n.name,r);addToWhitelist(n.email,function(){m()});Adb.sendHostCommand("host:track-devices",function(t){e.newSocket("tracker:",function(n){e.trackerSocket=n;Socket.stream(n,t)})})}isWhitelisted(n.email,function(e){if(e){i();return}var t=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:r,title:t,message:n.name+" is requesting access to Vysor shared Android devices.",buttons:[{title:"Allow"},{title:"Deny"}]},function(e){var t;var n=function(i){if(i!=e)return;chrome.notifications.onClosed.removeListener(n);chrome.notifications.onButtonClicked.removeListener(o);if(!t)a()};var o=function(n,o){if(n!=e)return;chrome.notifications.clear(n);t=true;if(o==0)i();else a()};chrome.notifications.onClosed.addListener(n);chrome.notifications.onButtonClicked.addListener(o)})})}if(n.picture){blobFromUrl(n.picture,function(e){r=e;d()})}else{r="/icon.png";d()}})})});e.openSocket=function(r,c){if(!t){c.destroy();return}if(r=="devices:"){d=throttleTimeout(d,c,500,function(e){Adb.devices(function(t){if(!t)t={};$.each(Object.keys(t),function(e,n){if(o[n])delete t[n]});var n={};$.each(Object.keys(i),function(e,t){n[t]={userInfo:i[t].userInfo}});$(e).each(function(e,o){writeString(o,{devices:t,sharedDevices:n},function(){o.destroy()})})})})}else if(r.startsWith("close:")){c.destroy();var u=r.split(":")[1];var l=s[u];if(l)l.destroy()}else{var f=r.indexOf(":");if(f==-1){console.error("unexpected command received by device farm server");c.destroy();return}var u=r.substring(0,f);if(!Y[u]){f=r.indexOf(":",f+1);if(f==-1){c.destroy();return}u=r.substring(0,f);if(!Y[u]){console.error("request for unknown device",u);return}}var l=s[u];if(!l){var h=Adb.createSocketFactory(u);l=s[u]=new GcmDevice(h,Y[u],{});l.destroy=function(){try{e.newSocket("close:"+u,function(e){e.destroy()})}catch(t){}var o=i[u];if(o){if(o.userInfo==n)delete o.userInfo;if(o.gcmConn==this)delete o.gcmConn;if(!o.key&&!o.gcmConn)delete i[u]}var r=this.onClose;if(r){delete this.onClose;r()}a()}.bind(l)}var p=i[u];if(!p)p=i[u]={};if(p.gcmConn!=l){F(u);p.gcmConn=l;p.userInfo=n;i[u]=p}a();var v=r.substring(f+1);l.openSocket(v,c)}}})})}function P(n){if(s){if(n){n(s)}return}chrome.app.window.create("list.html",{id:"list",innerBounds:{width:768,height:768,minWidth:768,minHeight:768}},function(o){s=o;s.contentWindow.onload=function(){if(navigator.platform.toLowerCase().indexOf("win")==-1){$(s.contentWindow.document).find("#windows").hide()}s.contentWindow.adbServer=e;s.contentWindow.tracker=a;chrome.storage.local.get("connect-automatically",function(e){var t=e["connect-automatically"]!==false;$(s.contentWindow.document).find("#connect-automatically-check").prop("checked",t)});$(s.contentWindow.document).find("#bitrate").change(g("Image Quality",function(){O(this.selectedIndex);chrome.storage.local.set({bitrate:this.selectedIndex})},function(){this.selectedIndex=0}));$(s.contentWindow.document).find("#connect-automatically-check").change(function(){chrome.storage.local.set({"connect-automatically":this.checked})});$(s.contentWindow.document).find("#share-all-check").change(function(){if(this.checked)x();else T()});$(s.contentWindow.document).find("#vysor-keyboard-check").change(function(){t=this.checked;chrome.storage.local.set({keyboard:this.checked})});chrome.storage.local.get("keyboard",function(e){t=e.keyboard;$(s.contentWindow.document).find("#vysor-keyboard-check").prop("checked",t)});$(s.contentWindow.document).find("#share-all-check").prop("checked",B.isListening("share"));$(s.contentWindow.document).find("#connect-android").hide();$(s.contentWindow.document).find("#tutorial").click(function(){openTutorial()});$(s.contentWindow.document).find("#purchase").click(function(){u.startPurchase()});$(s.contentWindow.document).find("#login").click(function(){$(s.contentWindow.document).find("#login-line").hide();$(s.contentWindow.document).find("#logging-in").show();u.cacheLicense(function(e){var t=chrome.runtime.getManifest().name;if(e){f(t,"Error saving license for offline use: "+e);$(s.contentWindow.document).find("#login-line").show();$(s.contentWindow.document).find("#logging-in").hide();return}$(s.contentWindow.document).find("#logging-in").hide();f(t,"License was saved for offline use. Thanks!")})});$(s.contentWindow.document).find("#connect-network").click(function(){s.contentWindow.showConnect()});chrome.storage.local.get("lastConnectAddress",function(e){if(e.lastConnectAddress)$(s.contentWindow.document).find("#connect-address")[0].value=e.lastConnectAddress});$(s.contentWindow.document).find("#connect-ok").click(function(){s.contentWindow.hideConnect();var e=$(s.contentWindow.document).find("#connect-address")[0].value;chrome.storage.local.set({lastConnectAddress:e});Adb.sendHostCommand("host:connect:"+e,function(e,t){if(!e)return;console.log("adb connect result",ab2str(t))})});$(s.contentWindow.document).find("#connect-cancel").click(function(){s.contentWindow.hideConnect()});p();v();m()};s.onClosed.addListener(function(){s=null;W()});if(n){controller=new Controller(receiverWindow.contentWindow,true);n(receiverWindow)}})}function M(t,n){e.start();var i=new Server;i.listen({port:0,address:"127.0.0.1"},function(e){i.destroy();var r=new AdbDaemon(new AdbTcpTransport(e));t(function(e){a.sendEvent("connected-shared-device");var t="127.0.0.1:"+i.localPort;e.serialno=t;o[t]=e;console.log("connected gcm socket");e.openSocket=function(){console.log("got a new socket? this should not happen...");e.destroy()};r.onClose=e.onClose=function(){delete o[t];r.destroy();e.destroy()};e.onClose=function(){delete o[t];r.destroy();e.destroy();showNotification("Disconnected from shared Android device.")};r.openSocket=function(t,n){e.newSocket(t,function(e){Socket.stream(n,e,function(){})})};e.newSocket("properties",function(e){readString(e,function(e){r.start(e);console.log("got properties",e);n(t)})})})}.bind(this),function(e){if(e){console.log("adb daemon failed to listen: "+e);return}var t="127.0.0.1:"+i.localPort;Adb.sendHostCommand("host:connect:"+t,function(e,t){if(!e){return}e.destroy();t=ab2str(t);console.log("adb connect result",t)})}.bind(this))}function N(e,t){showNotification("Vysor is connecting to a remote Android device");if(s)s.show();console.log("attempting to connect to shared device",e);if(!B){h();return}var n=new URL(e);var o=getQueryVariable("senderId",n);var i=getQueryVariable("registrationId",n);var r=getQueryVariable("channel",n);if(!o)o="64148182473";M(function(e){B.connect({senderId:o,registrationId:i,port:r},e)},t)}chrome.app.runtime.onLaunched.addListener(function(e){P();if(e&&e.id=="vysor_purchase"){u.refresh()}if(e&&e.id=="inkwire_share"){de(e.url)}if(e&&e.id=="vysor_presentation"){N(e.url,function(e){I(e)})}if(e&&e.id=="vysor_device_farm"){console.log("device farm",e.url);if(s)s.show();P();showNotification("Vysor is connecting to shared Android devices");chrome.identity.getAuthToken({interactive:true,scopes:["https://www.googleapis.com/auth/userinfo.profile","https://www.googleapis.com/auth/userinfo.email"]},function(t){if(!t){showNotification("Unable to get auth token");return}E(e.url,t)})}_()});function _(){chrome.runtime.requestUpdateCheck(function(e,t){if(e=="update_available"){ae()}})}var B;GcmRtcManager.start({3505780036:"AIzaSyDt0GimPRhk8_d_4XjOYzQUn50UkvXhMtE",64148182473:"AIzaSyDd7k1v017osyYbIC92fyf-36s3pv0z73U"},{iceServers:[{url:"turn:n0.clockworkmod.com",username:"foo",credential:"bar"},{url:"turn:n1.clockworkmod.com",username:"foo",credential:"bar"}]},function(e){B=e;B.defaultSenderId="64148182473";window.gcm=e});function F(e){var t=i[e];if(t&&t.gcmConn){var n=t.gcmConn;delete t.gcmConn;n.destroy()}}function V(e){F(e);delete i[e];Q()}function j(e,t){if(!B){h();return}var n=Math.round(Math.random()*(1<<30)).toString(16);if(!i[e])i[e]={};i[e].key=n;Q();var o="https://vysor.clockworkmod.com/redirect/"+encodeURIComponent(B.registrationId)+"/"+n;o="https://vysor.clockworkmod.com/app/vysor?registrationId="+encodeURIComponent(B.registrationId)+"&channel="+n;o="https://vysor.clockworkmod.com/redirect/?registrationId="+encodeURIComponent(B.registrationId)+"&channel="+n;console.log(o);B.listen(n,function(o){a.sendEvent("shared-device");var r=i[e];if(!r||r.key!=n){o.destroy();console.log("device is no longer being shared.");return}if(r.gcmConn)r.gcmConn.destroy();r.gcmConn=o;r.userInfo={name:"Someone"};Q();console.log("accepted gcm socket");var s=Adb.createSocketFactory(e);var c=new GcmDevice(s,t,o);c.onOpenSocket=function(t,n){if(t=="webstart"){S(e,null,function(t,o){writeLine(n,o,function(){console.log("sent password",o);n.destroy()});Adb.shell({command:"am start com.koushikdutta.vysor/.TipsActivity",serialno:e},function(){})});return true}}});copyTextToClipboard(o);var r=new Googl("AIzaSyCpibOeYoPpL8sMTjkliO8uRVRoaAcsge4");r.shorten(o,function(e){copyTextToClipboard(e);var t=chrome.runtime.getManifest().name;f("Copied "+t+" Share URL to clipboard",e)})}var K={};var H={};var Y={};var J;var z={};var X={};function G(e){var t=X[e];clearTimeout(t);X[e]=setTimeout(function(){delete X[e]},1e4);delete z[e]}function q(e){var t=z[e];clearTimeout(t);z[e]=setTimeout(function(){delete z[e]},1e4);delete X[e]}function Q(){if(!s)return;if(!J||e.isRunning()){$(s.contentWindow.document).find("#connect-android").show();$(s.contentWindow.document).find("#no-devices").hide()}else{$(s.contentWindow.document).find("#connect-android").hide();$(s.contentWindow.document).find("#no-devices").show()}if(!J){if(navigator.userAgent.indexOf("Windows NT 10")!=-1&&te==null){$(s.contentWindow.document).find("#adb-server-status").show();$(s.contentWindow.document).find("#adb-server-status").html("Windows 10 users MUST download the latest <a href='http://koush.com/post/universal-adb-driver' target='_blank'> Universal ADB Drivers</a>")}else{$(s.contentWindow.document).find("#adb-server-status").show();$(s.contentWindow.document).find("#adb-server-status").text("ADB not running. Click Find Devices to get started.")}ne()}else{$(s.contentWindow.document).find("#adb-server-status").show();if(e.isRunning()){$(s.contentWindow.document).find("#adb-server-status").text("Using built-in Vysor ADB.")}else{$(s.contentWindow.document).find("#adb-server-status").text("Using Android SDK ADB binary.")}}$.each($(s.contentWindow.document).find(".local-device"),function(e,t){if(!Y[t.name])$(t).remove()});$(s.contentWindow.document).find("#farms-list").empty();var t=Object.keys(Y);var n=Object.keys(r);if(!t.length){var c=$(s.contentWindow.document).find("#devices").find("#no-local-devices");if(!c.length){c=$('<a id="no-local-devices" href="https://www.youtube.com/watch?v=Ucs34BkfPB0&feature=youtu.be"><div class="alert alert-danger">No devices found. Make sure Android USB Debugging is enabled.</div></a>');$(s.contentWindow.document).find("#devices").append(c)}if(!J||e.isRunning()){$(s.contentWindow.document).find("#choose-header").hide();c.hide()}}else{$(s.contentWindow.document).find("#no-local-devices").remove();$(s.contentWindow.document).find("#choose-header").show();$(t).each(function(e,t){if(o[t]&&o[t].farm)return;var n=Y[t];var r=n.name;var c=r;if(n.status=="unauthorized")c="Unauthorized";var d=$(s.contentWindow.document).find("#devices").find('.local-device[name="'+t+'"]');if(!d.length){d=$('<a class="list-group-item local-device"><button type="button" class="btn btn-sm wireless btn-default"><i class="fa fa-wifi" title="Go Wireless"></i></button><button type="button" class="btn btn-sm share btn-default">Share</button><button type="button" class="btn btn-sm btn-success">View</button><img class="avatar img-rounded"></img><h5 class="list-group-item-heading" id="display"></h5><p class="list-group-item-text" id="serialno"></p></a>');d[0].name=t;var u=d.find(".share");var l=d.find("img");l.click(function(e){e.stopPropagation();var n=i[t].userInfo;blobFromUrl(n.picture,function(e){f("Vysor Share","Device in use by "+n.name)})});d.find(".wireless").click(g("Go Wireless",function(e){e.stopPropagation();var n=Adb.createSocketFactory(t);n.newSocket("shell:ifconfig wlan0",function(e){if(!e){console.log("error running tcpip:5555");return}readString(e,function(e){console.log("ifconfig result",e);var o=e.match("inet addr:(.*?) ");if(!o)o=e.match("wlan0: ip (.*?) ");if(!o){showNotification("Unable to switch to wireless mode. Is your Android connected to Wifi?");return}var i=o[1];var r=i+":5555";if(chrome.app.window.get(r)){K[t]=r;H[r]=t;I(r);return}function s(e){Adb.sendHostCommand("host:connect:"+r,function(t,n){if(!t){return}t.destroy();n=ab2str(n);if(n.indexOf("unable to connect")!=-1){showNotification("Unable to connect via wireless. Is your Android on the same network as your PC?");return}console.log("adb connect result",n);if(e)c()})}function c(){K[t]=r;H[r]=t;C(t);showNotification("Vysor is connected wirelessly. You may disconnect your device.");a.sendEvent("go-wireless");q(r);I(r,true,function(e){G(r);e.contentWindow.tryReconnect=function(){G(r);s(false)}})}if(Y[r]){c();return}q(t);n.newSocket("tcpip:5555",function(e){if(!e){showNotification("Failure while switching to wireless mode.");return}readString(e,function(e){console.log("tcpip:5555 result",e);s(true)})})})})},function(e){e.stopPropagation()}));if(o[t]){$(u).removeClass("btn-default").addClass("btn-danger");u.text("Disconnect Shared Device");u.click(function(e){e.stopPropagation();C(t);var n=o[t];if(n)n.destroy()})}else{$(u).removeClass("btn-danger").addClass("btn-default");u.click(g("Vysor Share",function(e){e.stopPropagation();if(i[t]){u.text("Share");V(t)}else{u.text("Unshare");j(t,n)}},function(e){e.stopPropagation()}))}d.click(function(){var e=Y[t];if(e.status=="unauthorized"){showNotification('Check your Android device and click "Allow USB Debugging".')}else{a.sendEvent("click-device",r);var n=K[t];if(n)C(n);I(t)}});$(s.contentWindow.document).find("#devices").append(d)}var h=H[t];if(h&&Y[h])d.hide();else d.show();var u=d.find(".share");var l=d.find("img");if(t.indexOf(":")!=-1)d.find(".wireless").hide();else d.find(".wireless").show();d.find("#display").text(c);d.find("#serialno").text("Serial: "+t);if(i[t]&&i[t].userInfo&&i[t].userInfo.picture){var p=i[t].userInfo;l.attr("alt","Device in use by "+p.name);blobFromUrl(p.picture,function(e){l.attr("src",e)});l.show()}else{l.hide()}if(i[t])u.text("Unshare");else u.text("Share");if(!B)u.hide();else u.show()})}$(n).each(function(e,t){var n=t;var o=g;if(n=="117634581230601031713"){o=function(e,t){return t}}t=r[t];if(!t.devices)return;var i=Object.keys(t.devices);if(!i.length)return;var c=$("<h5 class='list-header'>"+t.info.name+"'s Shared Devices <button class='btn btn-danger btn-xs' style='float: right;' type='button'>Disconnect</button></h5>");c.find("button").click(function(){t.gcmConn.destroy()});$(s.contentWindow.document).find("#farms-list").append(c);c=$("<div id='farm-"+n+"' class='list-group'></div>");$(s.contentWindow.document).find("#farms-list").append(c);$(i).each(function(e,n){var i=t.devices[n];var r=i.name;var s=r;var a;if(t.gcmConn.gcmConns[n])a="Serial: "+t.gcmConn.gcmConns[n].serialno;else a="Remote Serial: "+n;var d=$('<a class="list-group-item"><button type="button" class="btn btn-sm connect"></button><button type="button" class="btn btn-sm btn-success">View</button><img class="avatar img-rounded"></img><h5 class="list-group-item-heading">'+s+'</h5><p class="list-group-item-text">'+a+"</p></a>");var u=d.find("img");if(t.sharedDevices&&t.sharedDevices[n]&&t.sharedDevices[n].userInfo){var h=t.sharedDevices[n].userInfo;u.attr("alt","Device in use by "+h.name);blobFromUrl(h.picture,function(e){u.attr("src",e)});u.click(function(e){e.stopPropagation();blobFromUrl(h.picture,function(e){f("Vysor Share","Device in use by "+h.name)})})}else{u.hide()}if(t.gcmConn.gcmConns[n])d.find(".connect").text("Disconnect").addClass("btn-danger");else d.find(".connect").text("Connect").addClass("btn-default");function p(e){if(t.sharedDevices&&t.sharedDevices[n]&&t.sharedDevices[n].userInfo){if(t.sharedDevices[n].userInfo.id==R.id){e();return}l({title:"Android In Use",body:"This Android is currently in use by "+h.name+". Do you want to boot them off?",okButton:"Connect Anyways",ok:e})}else{e()}}d.find(".connect").click(o("Vysor Share",function(e){e.stopPropagation();var o=t.gcmConn.gcmConns[n];if(o){o.destroy();d.find(".connect").text("Connect");C(o.serialno)}else{p(function(){d.find(".connect").text("Disconnect");U(t,n,function(e){q(e)})})}},function(e){e.stopPropagation()}));d.click(o("Vysor Share",function(e){p(function(){var e=t.gcmConn.gcmConns[n];if(e){I(e.serialno)}else{d.find(".connect").text("Connect");U(t,n,function(e){I(e)})}})},function(e){e.stopPropagation()}));c.append(d)});$(s.contentWindow.document).find("#farms-list").append(c)})}var Z;function ee(){chrome.storage.local.get("connect-automatically",function(t){var n=t["connect-automatically"]!==false;Adb.devices(function(t){if(t){var o=[];var i;$.each(t,function(o,r){i=true;if(!Y[o]){a.sendEvent("found-device",r.name);V(o);var c=t[o];var d=c.properties.indexOf("emulator")!=-1||c.properties.indexOf("vbox")!=-1;if(!d&&Z&&!z[o]){if(n||chrome.app.window.get(o)||e.isRunning()||X[o]){I(o,true);if(!s&&!chrome.app.window.get(o)){var u=chrome.runtime.getManifest().name;chrome.notifications.create("never-start-automatically",{type:"basic",iconUrl:"/icon.png",title:u,message:"Vysor has connected to an Android device and is starting.",buttons:[{title:"Never Start Automatically"}]})}}}}});Y=t;if(s){if(i||!e.isRunning())$(s.contentWindow.document).find("#not-found").hide();else $(s.contentWindow.document).find("#not-found").show()}}else{Y={}}Q();Z=true})})}var te;function ne(){if(te)return;te=chrome.runtime.connectNative("com.clockworkmod.adb");te.onDisconnect.addListener(function(){te=null});te.postMessage({command:"start-server"})}var oe;var ie;function re(){if(oe)return;function t(){ie=throttleTimeout(ie,null,300,function(){ee()})}function n(e){e.read(function(o){t();n(e)})}Adb.sendHostCommand("host:track-devices",function(o){if(oe){o.destroy();return}if(!o)return;console.log("Connected to ADB Server");if(e.isRunning())console.log("Using Vysor ADB");else console.log("Using Android SDK ADB");J=true;o.onClose=function(){oe=null;J=false;t()};oe=o;n(o);t()})}function se(){re();Q();setTimeout(se,1e3)}se();ee();var ce;function ae(){ce=throttleTimeout(ce,null,1e4,function(){var e=chrome.runtime.getManifest().name;chrome.notifications.create("reload",{type:"basic",iconUrl:"/icon.png",title:e,message:"There is an update available for Vysor.",buttons:[{title:"Reload"}]})})}chrome.runtime.onUpdateAvailable.addListener(function(){W()});chrome.notifications.onButtonClicked.addListener(function(e,t){if(e=="reload"){chrome.runtime.reload()}else if(e=="never-start-automatically"){chrome.storage.local.set({"connect-automatically":false});if(s){$(s.contentWindow.document).find("#connect-automatically-check").prop("checked",false)}chrome.notifications.clear(e)}});chrome.notifications.onClicked.addListener(function(e,t){});function de(e){var t=new URL(e).hash.replace("#","");$.ajax({type:"get",url:"https://inkwire-6c41e.appspot.com/register",data:{key:t},dataType:"json",success:function(e){if(!e.data){console.log("inkwire session not found");return}gcm.connect({senderId:"3505780036",registrationId:e.data.registrationId,port:t},function(n){var o;var i;var r;gcm.connect({senderId:"3505780036",registrationId:e.data.registrationId,port:t,audio:true},function(e,t){o=e;console.log("got audio");i=new Audio;r=t.stream.getAudioTracks()[0];i.src=(URL||webkitURL||mozURL).createObjectURL(t.stream);i.play()});chrome.app.window.create("screen.html",{id:"inkwire-"+t,bounds:{width:576,height:1024}},function(e){var t;e.onClosed.addListener(t=function(){e.onClosed.removeListener(t);nextTick(function(){if(o){o.destroy();o=null}if(i){i.pause();i=null;r.stop();r=null}n.destroy();n=null})});e.contentWindow.onload=function(){e.contentWindow.adbSocketFactory=n;e.contentWindow.openList=function(){};e.contentWindow.password="test";e.contentWindow.serialno="test";e.contentWindow.acceleration="software";e.contentWindow.port=1111;e.contentWindow.Function.prototype.libind=function(e,t){return function(){this.apply(t,arguments)}.bind(this)};e.contentWindow.docReady();e.contentWindow.connectionReady()}})})},error:function(e,t){}})}console.log("Vysor version",chrome.runtime.getManifest().version);console.log(navigator.userAgent)})();
